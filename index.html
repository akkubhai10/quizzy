<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizzy - Master Your Skills</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        /* --- 1. THEME VARIABLES (NEON & GLASS) --- */
        :root {
            --primary: #4F46E5;
            --primary-glow: rgba(79, 70, 229, 0.5);
            --primary-light: #EEF2FF;
            --bg: #F3F4F6;
            --surface: #FFFFFF;
            --text: #1F2937;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --header-height: 60px;
            --glass-filter: none;
            --card-border: 1px solid var(--border);
            --warning: #F59E0B;
        }

        /* --- DARK MODE (NEON + GLASS CONFIGURATION) --- */
        body.dark-mode {
            --bg: #050505; /* Deepest Black */
            --surface: rgba(20, 20, 25, 0.65); /* Semi-transparent */
            --text: #e0e0e0;
            --text-muted: #9ca3af;
            --primary: #6366f1; /* Brighter Indigo */
            --primary-light: rgba(99, 102, 241, 0.15);
            --primary-glow: rgba(99, 102, 241, 0.6);
            --border: rgba(255, 255, 255, 0.08);
            --card-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-filter: blur(12px); /* The Glass Effect */
            --shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* --- 2. BASE STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; transition: background 0.3s, color 0.3s; }
        
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }

        /* --- 3. NEON & GLASS OVERRIDES --- */
        
        /* Apply Glass Effect to specific containers in Dark Mode */
        body.dark-mode .card, 
        body.dark-mode .list-item,
        body.dark-mode .auth-card,
        body.dark-mode .sidebar,
        body.dark-mode #app-header,
        body.dark-mode .modal-content,
        body.dark-mode .search-input {
            background: var(--surface);
            backdrop-filter: var(--glass-filter);
            -webkit-backdrop-filter: var(--glass-filter);
            border: var(--card-border);
            box-shadow: var(--shadow);
        }

        /* Neon Text Glow for Headings */
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        /* --- 4. COMPONENTS --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 20px; border-radius: var(--radius); border: none;
            cursor: pointer; font-weight: 500; transition: 0.2s; font-size: 0.95rem; width: 100%;
        }
        .btn-primary { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); 
        }
        /* Neon Button in Dark Mode */
        body.dark-mode .btn-primary {
            box-shadow: 0 0 15px var(--primary-glow);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        
        /* Report Button Style */
        .btn-warning-outline {
            background: transparent;
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 6px 12px; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-warning-outline:hover {
            background: var(--warning);
            color: white;
        }

        .input-field {
            width: 100%; padding: 14px; border: 1px solid var(--border);
            border-radius: var(--radius); background: var(--surface); color: var(--text);
            outline: none; margin-bottom: 15px; transition: 0.2s;
        }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        /* Neon Input Focus in Dark Mode */
        body.dark-mode .input-field:focus {
            box-shadow: 0 0 15px var(--primary-glow);
        }

        /* --- 5. SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; inset: 0; background: var(--surface); z-index: 9999;
            flex-direction: column;
            transition: opacity 0.5s ease-out;
        }
        .splash-logo {
            width: 80px; height: 80px; border-radius: 20px; object-fit: cover;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
            animation: pulse 2s infinite; margin-bottom: 20px;
            background: var(--primary-light);
            display: flex; align-items: center; justify-content: center;
        }
        body.dark-mode .splash-logo {
            box-shadow: 0 0 50px var(--primary); /* Strong Neon Glow */
            background: rgba(99, 102, 241, 0.2);
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

        /* --- 6. AUTH (Login/Signup) --- */
        #auth-container {
            min-height: 100vh; display: flex; flex-direction: column; justify-content: center;
            padding: 20px; max-width: 450px; margin: 0 auto;
        }
        .auth-card {
            background: var(--surface); padding: 30px; border-radius: 24px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .auth-logo { width: 50px; height: 50px; border-radius: 12px; margin-bottom: 15px; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }

        /* --- 7. MAIN APP HEADER --- */
        #app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--surface); display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: var(--shadow); z-index: 100;
            border-bottom: 1px solid var(--border);
        }
        .app-brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.2rem; color: var(--primary); }
        .header-logo-img { width: 32px; height: 32px; border-radius: 8px; object-fit: cover; display: none; }
        
        .hamburger { font-size: 1.5rem; cursor: pointer; color: var(--text); padding: 5px; }

        /* --- 8. MAIN CONTENT --- */
        #main-content { margin-top: var(--header-height); padding: 20px; padding-bottom: 80px; max-width: 800px; margin-left: auto; margin-right: auto; }

        /* Banner Slider */
        .banner-container {
            width: 100%;
            height: 180px; 
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            background: var(--surface);
            display: none; 
        }
        .banner-wrapper { display: flex; height: 100%; transition: transform 0.5s ease-in-out; }
        .banner-slide { min-width: 100%; height: 100%; position: relative; }
        .banner-img { width: 100%; height: 100%; object-fit: cover; }
        .banner-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: white; width: 20px; border-radius: 4px; }

        /* Search */
        .search-box { position: relative; margin-bottom: 25px; }
        .search-input {
            width: 100%; padding: 15px 45px 15px 20px; border-radius: 30px; border: none;
            background: var(--surface); box-shadow: var(--shadow); color: var(--text);
            transition: 0.3s;
        }
        /* Neon Search Focus */
        body.dark-mode .search-input:focus {
            border: 1px solid var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
        }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        /* Breadcrumbs */
        .breadcrumbs { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px; }
        .bc-active { color: var(--primary); font-weight: 600; }

        /* Grid & Cards */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card {
            background: var(--surface); border-radius: 16px; overflow: hidden;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; cursor: pointer;
        }
        .card:active { transform: scale(0.97); }
        /* Neon Hover Effect on Cards */
        body.dark-mode .card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow), inset 0 0 10px rgba(255,255,255,0.05);
        }

        .card-poster { height: 100px; width: 100%; object-fit: cover; background: var(--primary-light); }
        .card-body { padding: 15px; }
        .card-title { font-weight: 600; font-size: 1rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Skeleton Loading */
        .skeleton {
            background: #e1e4e8;
            background: linear-gradient(to right, #e1e4e8 0%, #f0f2f5 50%, #e1e4e8 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        .dark-mode .skeleton {
            background: #374151;
            background: linear-gradient(to right, #374151 0%, #4b5563 50%, #374151 100%);
        }
        @keyframes shimmer { 0% {background-position: -200% 0;} 100% {background-position: 200% 0;} }
        .skeleton-card { height: 160px; border-radius: 16px; }

        /* List Items */
        .list-item {
            background: var(--surface); padding: 15px; border-radius: 12px;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow); border: 1px solid var(--border); cursor: pointer;
        }
        .icon-btn { width: 35px; height: 35px; border-radius: 50%; background: var(--bg); display: grid; place-items: center; color: var(--primary); }

        /* --- 9. SIDEBAR --- */
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; opacity: 0; pointer-events: none; transition: 0.3s; }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
        
        .sidebar {
            position: fixed; top: 0; right: -280px; width: 280px; height: 100%;
            background: var(--surface); z-index: 201; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar.active { right: 0; }
        
        .sidebar-header { padding: 25px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: grid; place-items: center; font-size: 1.2rem; }
        
        .menu-items { padding: 15px; overflow-y: auto; flex: 1; }
        .menu-link {
            padding: 15px; display: flex; align-items: center; gap: 15px;
            color: var(--text); border-radius: 10px; cursor: pointer; transition: 0.2s;
        }
        .menu-link:hover { background: var(--bg); }
        body.dark-mode .menu-link:hover { background: rgba(255,255,255,0.05); }
        .menu-link i { width: 25px; color: var(--text-muted); }

        /* --- 10. MODALS (FIXED Z-INDEX) --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
            z-index: 2000 !important; /* FIXED: Must be higher than quiz overlay */
            display: flex; align-items: center; justify-content: center; padding: 20px;
            opacity: 0; pointer-events: none; transition: 0.2s; backdrop-filter: blur(5px);
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--surface); width: 100%; max-width: 400px;
            padding: 25px; border-radius: 20px; transform: translateY(20px); transition: 0.3s;
            max-height: 80vh; overflow-y: auto;
        }
        .modal.active .modal-content { transform: translateY(0); }

        /* --- 11. QUIZ OVERLAY --- */
        #quiz-overlay {
            position: fixed; inset: 0; background: white; 
            z-index: 1000; /* FIXED: Lower than modal */
            display: flex; flex-direction: column;
        }
        body.dark-mode #quiz-overlay { background: #000; }

        .quiz-header-bar {
            height: 60px; background: #fff; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; gap: 10px;
        }
        body.dark-mode .quiz-header-bar { background: #111; border-color: #333; }
        body.dark-mode .quiz-header-bar span { color: #fff !important; }

        #quiz-frame { 
            flex: 1; 
            border: none; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            transition: opacity 0.3s ease-in-out;
            background: white;
        }
        body.dark-mode #quiz-frame { background: #000; }

    </style>
</head>
<body>

    <div id="splash-screen" class="flex-center">
        <div class="splash-logo flex-center" style="color: white;">
            <i class="fas fa-graduation-cap" style="font-size: 40px;"></i>
        </div>
        <div style="font-size:2rem; font-weight:700; color:var(--primary);">Quizzy</div>
        <p style="color:var(--text-muted); margin-top:10px;">Master your skills...</p>
    </div>

    <div id="auth-container" class="hidden">
        <div class="auth-card">
            <div class="text-center" style="margin-bottom:20px;">
                <div style="display: flex; justify-content: center;">
                    <div class="auth-logo"><i class="fas fa-user"></i></div>
                </div>
                <h2 id="auth-title" style="text-align:center;">Sign In</h2>
                <p style="color:var(--text-muted); font-size:0.9rem; text-align:center;">Welcome back to Quizzy</p>
            </div>
            
            <form id="auth-form">
                <div id="name-field" class="hidden">
                    <input type="text" id="user-name" class="input-field" placeholder="Full Name">
                </div>
                <input type="email" id="user-email" class="input-field" placeholder="Email Address" required>
                <input type="password" id="user-pass" class="input-field" placeholder="Password" required>
                
                <div id="forgot-pass-box" style="text-align:right; margin-bottom:15px;">
                    <span style="font-size:0.85rem; color:var(--primary); cursor:pointer; font-weight:500;" onclick="resetPassword()">
                        Forgot Password?
                    </span>
                </div>
                <button type="submit" class="btn btn-primary" id="auth-btn">Sign In</button>
            </form>

            <div class="text-center" style="margin-top:20px; text-align:center;">
                <p style="color:var(--text-muted); font-size:0.9rem; cursor:pointer;" onclick="toggleAuth()">
                    <span id="auth-toggle-text">Don't have an account? <b>Sign Up</b></span>
                </p>
            </div>
        </div>
    </div>

    <header id="app-header" class="hidden">
        <div class="app-brand">
            <img src="" id="header-logo-img" class="header-logo-img">
            <span id="app-name-display">Quizzy</span>
        </div>
        <i class="fas fa-bars hamburger" onclick="toggleSidebar()"></i>
    </header>

    <main id="main-content" class="hidden">
        
        <div id="banner-section" class="banner-container">
            <div class="banner-wrapper" id="banner-wrapper"></div>
            <div class="banner-dots" id="banner-dots"></div>
        </div>

        <div class="search-box" id="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="Search subjects, chapters...">
            <i class="fas fa-search search-icon"></i>
        </div>

        <div id="welcome-section" style="margin-bottom:20px;">
            <h2 style="font-weight:600;">Hello, <span id="display-user-name" style="color:var(--primary);">User</span> ðŸ‘‹</h2>
            <p style="color:var(--text-muted); font-size:0.9rem;">What would you like to learn today?</p>
        </div>

        <div id="breadcrumbs" class="breadcrumbs hidden">
            <span onclick="renderSubjects()"><i class="fas fa-home"></i> Home</span>
            <i class="fas fa-chevron-right" style="font-size:0.7rem;"></i>
            <span id="bc-current" class="bc-active">Physics</span>
        </div>

        <div id="content-area"></div>
    </main>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="user-avatar" id="sidebar-avatar">U</div>
            <div>
                <h4 id="sidebar-name">User Name</h4>
                <p id="sidebar-email" style="font-size:0.8rem; color:var(--text-muted);">email@example.com</p>
            </div>
        </div>
        <div class="menu-items">
            <div class="menu-link" onclick="toggleDarkMode()">
                <i class="fas fa-moon"></i> <span>Dark Mode</span>
            </div>
            
            <div class="menu-link" onclick="shareApp()">
                <i class="fas fa-share-alt"></i> <span>Share it</span>
            </div>
            <div class="menu-link" onclick="openFollowLinks()">
                <i class="fas fa-hashtag"></i> <span>Follow Me</span>
            </div>
            <div class="menu-link" onclick="showPrivacy()">
                <i class="fas fa-user-shield"></i> <span>Privacy Policy</span>
            </div>
            <div class="menu-link" onclick="showHelp()">
                <i class="fas fa-qrcode"></i> <span>Help</span>
            </div>
            <div class="menu-link" onclick="openFeedbackModal()">
                <i class="fas fa-comment-dots"></i> <span>Feedback</span>
            </div>
            
            <div class="menu-link hidden" id="admin-link-item" onclick="window.location.href='admin.html'">
                <i class="fas fa-cog" style="color:var(--primary);"></i> <span style="color:var(--primary); font-weight:700;">Admin Panel</span>
            </div>

            <div class="menu-link" onclick="handleLogout()" style="margin-top:20px; border-top:1px solid var(--border); color:#ef4444;">
                <i class="fas fa-sign-out-alt" style="color:#ef4444;"></i> <span>Logout</span>
            </div>
        </div>
    </aside>

    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-bottom:15px;">Title</h3>
            <div id="modal-body" style="color:var(--text-muted); font-size:0.95rem; line-height:1.6;">Content</div>
            <button class="btn btn-primary" style="margin-top:20px;" onclick="closeModal()">Close</button>
        </div>
    </div>

    <div id="feedback-modal" class="modal">
        <div class="modal-content">
            <h3>Send Feedback</h3>
            <textarea id="feedback-text" class="input-field" rows="4" style="margin-top:15px; resize:none;" placeholder="Your suggestions..."></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitFeedback()">Send</button>
            </div>
        </div>
    </div>

    <div id="quiz-overlay" class="hidden">
        <div class="quiz-header-bar">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden;">
                <button class="btn-warning-outline" onclick="openReportQuizModal()">
                    <i class="fas fa-exclamation-circle"></i> Report
                </button>
                <span style="font-weight:600; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="quiz-overlay-title">Playing Quiz</span>
            </div>

            <button style="background:#ef4444; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:500; white-space:nowrap; flex-shrink: 0;" onclick="closeQuiz()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <iframe id="quiz-frame" src=""></iframe>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCtRO8vGZ9IgNpjqhQvzY4vrYHeEB6c6ps",
            authDomain: "quizzy-akash.firebaseapp.com",
            databaseURL: "https://quizzy-akash-default-rtdb.firebaseio.com",
            projectId: "quizzy-akash",
            storageBucket: "quizzy-akash.firebasestorage.app",
            messagingSenderId: "694150825596",
            appId: "1:694150825596:web:dd92b011111ef7817debf9"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- 2. STATE ---
        let state = {
            user: null,
            config: {},
            subjects: [],
            activeSubject: null,
            activeChapter: null,
            view: 'home', // home | chapters | quizzes | playing
            quizActive: false,
            activeQuizTitle: null,
            activeQuizUrl: null
        };

        const els = {
            splash: document.getElementById('splash-screen'),
            auth: document.getElementById('auth-container'),
            header: document.getElementById('app-header'),
            main: document.getElementById('main-content'),
            content: document.getElementById('content-area'),
            sidebar: document.getElementById('sidebar'),
            overlay: document.querySelector('.sidebar-overlay'),
            breadcrumbs: document.getElementById('breadcrumbs')
        };

        // --- 3. INITIALIZATION & BAN CHECK ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // IMPORTANT: Check if user is banned
                db.ref(`users/${user.uid}/isBanned`).once('value', snap => {
                    if (snap.val() === true) {
                        // User is banned
                        auth.signOut().then(() => {
                            alert("Access Denied: Your account has been banned by the administrator.");
                            window.location.reload();
                        });
                    } else {
                        // User is allowed
                        state.user = user;
                        initApp(); 
                    }
                });
            } else {
                els.splash.style.opacity = '0';
                setTimeout(() => {
                    els.splash.classList.add('hidden');
                    els.auth.classList.remove('hidden');
                }, 500);
            }
        });

        function initApp() {
            els.splash.style.opacity = '0';
            setTimeout(() => els.splash.classList.add('hidden'), 500);
            els.auth.classList.add('hidden');
            els.header.classList.remove('hidden');
            els.main.classList.remove('hidden');

            document.getElementById('display-user-name').innerText = state.user.displayName || 'Learner';
            document.getElementById('sidebar-name').innerText = state.user.displayName || 'Learner';
            document.getElementById('sidebar-email').innerText = state.user.email;
            document.getElementById('sidebar-avatar').innerText = (state.user.displayName || 'U')[0].toUpperCase();

            if(localStorage.getItem('quizzy_dark') === 'true') document.body.classList.add('dark-mode');

            // Initialize History for Navigation
            history.replaceState({ view: 'home' }, null, "");

            showSkeletons();
            loadContent();
            loadConfig();
            checkAdmin();
            initBanners();

            // --- SEARCH BAR LOGIC ---
            // Handles Moving Search to top on focus & restoring on blur
            const searchContainer = document.getElementById('search-container');
            const searchInp = document.getElementById('search-input');
            const bannerSec = document.getElementById('banner-section');
            const welcomeSec = document.getElementById('welcome-section');

            searchInp.addEventListener('focus', () => {
                if(state.view === 'home') {
                    bannerSec.classList.add('hidden');
                    welcomeSec.classList.add('hidden');
                }
            });

            searchInp.addEventListener('blur', () => {
                // Restore only if empty and we are still on home
                if(searchInp.value.trim() === '' && state.view === 'home') {
                    welcomeSec.classList.remove('hidden');
                    // Check if banner has content before showing
                    if(document.getElementById('banner-wrapper').children.length > 0) {
                        bannerSec.classList.remove('hidden');
                    }
                }
            });
        }

        // --- 4. BANNER SLIDER LOGIC ---
        let bannerInterval;

        function initBanners() {
            db.ref('banners').on('value', snap => {
                const bannersObj = snap.val() || {};
                const bannerKeys = Object.keys(bannersObj);
                const container = document.getElementById('banner-section');
                const wrapper = document.getElementById('banner-wrapper');
                const dotsContainer = document.getElementById('banner-dots');
                
                if (bannerKeys.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                // Show banner only if view is 'home', else keep it hidden but populate it
                if(state.view === 'home') {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }

                wrapper.innerHTML = '';
                dotsContainer.innerHTML = '';
                
                // Render Slides and Dots
                bannerKeys.forEach((key, index) => {
                    const b = bannersObj[key];
                    
                    // Slide
                    const slide = document.createElement('div');
                    slide.className = 'banner-slide';
                    slide.innerHTML = `<a href="${b.targetUrl}" target="_blank"><img src="${b.imageUrl}" class="banner-img"></a>`;
                    wrapper.appendChild(slide);
                    
                    // Dot
                    const dot = document.createElement('div');
                    dot.className = index === 0 ? 'dot active' : 'dot';
                    dotsContainer.appendChild(dot);
                });

                // Start Auto Slide
                startBannerAnimation(bannerKeys.length);
            });
        }

        function startBannerAnimation(count) {
            if(count <= 1) return; // Don't slide if only 1 image
            
            if(bannerInterval) clearInterval(bannerInterval);
            
            let currentIndex = 0;
            const wrapper = document.getElementById('banner-wrapper');
            const dots = document.querySelectorAll('.dot');
            
            bannerInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % count;
                wrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
                dots.forEach(d => d.classList.remove('active'));
                dots[currentIndex].classList.add('active');
            }, 4000); 
        }

        // --- 5. NAVIGATION HISTORY HANDLER ---
        window.onpopstate = function(event) {
            const historyState = event.state;

            // If quiz is active, close it first
            if (state.quizActive) {
                closeQuiz(false); // false = don't push history, just close UI
                return;
            }

            if (!historyState || historyState.view === 'home') {
                renderSubjects(false);
            } else if (historyState.view === 'chapters') {
                openSubject(historyState.subId, false);
            } else if (historyState.view === 'quizzes') {
                if(state.activeSubject && state.activeSubject.id === historyState.subId) {
                    openChapter(historyState.chapId, false);
                } else {
                    openSubject(historyState.subId, false);
                }
            }
        };

        function loadConfig() {
            db.ref('config').once('value', snap => {
                const conf = snap.val() || {};
                state.config = conf;
                updateUI(conf);
            });
        }

        function checkAdmin() {
            db.ref(`admins/${state.user.uid}`).once('value', snap => {
                if(snap.val() === true) document.getElementById('admin-link-item').classList.remove('hidden');
            });
        }

        function updateUI(conf) {
            if(conf.appName) document.getElementById('app-name-display').innerText = conf.appName;
            const logo = conf.logoUrl || ''; 
            if(logo) {
                const headLogo = document.getElementById('header-logo-img');
                headLogo.src = logo;
                headLogo.style.display = 'block';
            }
        }

        function showSkeletons() {
            els.content.innerHTML = '<div class="grid-container">' + 
                Array(6).fill('<div class="skeleton skeleton-card"></div>').join('') + 
                '</div>';
        }

        // --- 6. RENDERING ---
        function loadContent() {
            db.ref('subjects').once('value', snap => {
                state.subjects = [];
                els.content.innerHTML = '';
                
                if(!snap.exists()) {
                    els.content.innerHTML = '<p class="text-center">No subjects added yet.</p>';
                    return;
                }

                els.content.innerHTML = '<div class="grid-container" id="sub-grid"></div>';
                const grid = document.getElementById('sub-grid');

                snap.forEach(child => {
                    const sub = { id: child.key, ...child.val() };
                    state.subjects.push(sub);
                    
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.onclick = () => openSubject(sub.id);
                    div.innerHTML = `
                        ${sub.poster ? `<img src="${sub.poster}" class="card-poster">` : `<div class="card-poster flex-center" style="font-size:2rem; color:var(--primary);"><i class="fas fa-book"></i></div>`}
                        <div class="card-body">
                            <div class="card-title">${sub.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${sub.chapters ? Object.keys(sub.chapters).length : 0} Chapters</div>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            });
        }
        
        function renderSubjects(pushHistory = true) {
            state.view = 'home';
            state.quizActive = false;
            els.breadcrumbs.classList.add('hidden');

            // --- SHOW SEARCH & WELCOME (Home View) ---
            document.getElementById('search-container').style.display = 'block';
            document.getElementById('welcome-section').classList.remove('hidden');

            // Show Banner (if it has content)
            const bannerContainer = document.getElementById('banner-section');
            if(document.getElementById('banner-wrapper').children.length > 0) {
                 bannerContainer.style.display = 'block';
                 bannerContainer.classList.remove('hidden');
            }

            if(pushHistory) {
                history.pushState({ view: 'home' }, null, "");
            }
            
            if(state.subjects.length > 0) {
                 els.content.innerHTML = '<div class="grid-container" id="sub-grid"></div>';
                 const grid = document.getElementById('sub-grid');
                 state.subjects.forEach(sub => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.onclick = () => openSubject(sub.id);
                    div.innerHTML = `
                        ${sub.poster ? `<img src="${sub.poster}" class="card-poster">` : `<div class="card-poster flex-center" style="font-size:2rem; color:var(--primary);"><i class="fas fa-book"></i></div>`}
                        <div class="card-body">
                            <div class="card-title">${sub.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${sub.chapters ? Object.keys(sub.chapters).length : 0} Chapters</div>
                        </div>
                    `;
                    grid.appendChild(div);
                 });
            } else {
                loadContent(); 
            }
        }

        function openSubject(id, pushHistory = true) {
            const sub = state.subjects.find(s => s.id === id);
            if(!sub) return;
            state.activeSubject = sub;
            state.view = 'chapters';

            // --- HIDE BANNER & SEARCH (Chapter View) ---
            document.getElementById('banner-section').style.display = 'none';
            document.getElementById('search-container').style.display = 'none';

            if(pushHistory) {
                history.pushState({ view: 'chapters', subId: id }, null, "");
            }

            els.breadcrumbs.classList.remove('hidden');
            document.getElementById('bc-current').innerText = sub.name;
            document.getElementById('bc-current').onclick = null; 

            els.content.innerHTML = '<div id="list-container"></div>';
            const container = document.getElementById('list-container');

            if(!sub.chapters) {
                container.innerHTML = '<p class="text-center">No chapters yet.</p>';
                return;
            }

            Object.keys(sub.chapters).forEach(key => {
                const chap = sub.chapters[key];
                const qCount = chap.quizzes ? Object.keys(chap.quizzes).length : 0;
                chap.realId = key;

                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => openChapter(key);
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600;">${chap.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">${qCount} Quizzes</div>
                    </div>
                    <div class="icon-btn"><i class="fas fa-chevron-right"></i></div>
                `;
                container.appendChild(div);
            });
        }

        function openChapter(chapId, pushHistory = true) {
            const sub = state.activeSubject;
            const chap = sub.chapters[chapId];
            state.activeChapter = chap;
            state.view = 'quizzes';

            // --- HIDE BANNER & SEARCH (Quiz List View) ---
            document.getElementById('banner-section').style.display = 'none';
            document.getElementById('search-container').style.display = 'none';

            if(pushHistory) {
                history.pushState({ view: 'quizzes', subId: sub.id, chapId: chapId }, null, "");
            }

            document.getElementById('bc-current').innerText = sub.name;
            document.getElementById('bc-current').onclick = () => {
                history.back();
            };

            els.content.innerHTML = `<h3>${chap.name}</h3><div id="list-container" style="margin-top:15px;"></div>`;
            const container = document.getElementById('list-container');

            if(!chap.quizzes) {
                container.innerHTML += '<p>No quizzes available.</p>';
                return;
            }

            Object.keys(chap.quizzes).forEach(key => {
                const quiz = chap.quizzes[key];
                const path = `quizzes/${encodeURIComponent(sub.name)}/${encodeURIComponent(chap.name)}/${quiz.fileName}`;
                
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => startQuiz(path, quiz.title);
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600;">${quiz.title}</div>
                    </div>
                    <div class="icon-btn" style="background:var(--primary-light);"><i class="fas fa-play"></i></div>
                `;
                container.appendChild(div);
            });
        }

        // --- 7. QUIZ LOGIC ---
        function startQuiz(url, title) {
            state.quizActive = true;
            state.activeQuizTitle = title;
            state.activeQuizUrl = url;
            
            // Set header title
            document.getElementById('quiz-overlay-title').innerText = title;

            const overlay = document.getElementById('quiz-overlay');
            const frame = document.getElementById('quiz-frame');

            history.pushState({ view: 'playing' }, null, "");

            overlay.classList.remove('hidden');
            frame.style.opacity = "0";
            frame.src = "about:blank";

            setTimeout(() => {
                frame.src = url;
            }, 50);

            frame.onload = () => {
                if(frame.src !== "about:blank") {
                    frame.style.opacity = "1";
                }
            };
        }

        function closeQuiz(goBackInHistory = true) {
            state.quizActive = false;
            const overlay = document.getElementById('quiz-overlay');
            const frame = document.getElementById('quiz-frame');

            overlay.classList.add('hidden');
            frame.style.opacity = "0";
            frame.src = "about:blank"; 
            
            if(goBackInHistory) {
                history.back();
            }
        }

        // --- 8. MENU & UTILS ---
        function toggleSidebar() {
            els.sidebar.classList.toggle('active');
            els.overlay.classList.toggle('active');
        }

        function handleLogout() {
            auth.signOut().then(() => {
                window.location.reload();
            }).catch(error => {
                toast("Logout Error: " + error.message);
            });
        }

        function shareApp() {
            const adminMessage = state.config.shareText || "Join me on Quizzy!";
            if (navigator.share) {
                navigator.share({ title: state.config.appName || 'Quizzy', text: adminMessage }).catch((error) => console.log('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(adminMessage);
                toast("Message copied to clipboard!");
            }
        }
        
        function openFollowLinks() {
            toggleSidebar();
            const linksObj = state.config.socialLinks;
            if(!linksObj) { toast("No social links added by admin."); return; }
            const links = Object.values(linksObj);
            let html = '<div class="grid-container" style="grid-template-columns:1fr 1fr;">';
            links.forEach(l => {
                html += `<a href="${l.url}" target="_blank" class="btn btn-outline" style="text-decoration:none; display:flex; gap:10px; justify-content:center;">${l.iconUrl ? `<img src="${l.iconUrl}" style="width:20px;">` : '<i class="fas fa-link"></i>'}${l.platform}</a>`;
            });
            html += '</div>';
            openModal('Follow Me', html);
        }

        function showPrivacy() {
            toggleSidebar();
            openModal('Privacy Policy', state.config.privacyPolicy || "Not defined yet.");
        }

        function showHelp() {
            toggleSidebar();
            const qr = state.config.help?.qrImageUrl;
            const msg = state.config.help?.message || "Scan to contact us.";
            let html = '<div class="text-center">';
            if(qr) html += `<img src="${qr}" style="width:200px; height:200px; margin-bottom:15px; border-radius:10px;">`;
            html += `<p>${msg}</p></div>`;
            openModal('Help & Support', html);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('quizzy_dark', document.body.classList.contains('dark-mode'));
        }

        function openModal(title, content) {
            document.getElementById('generic-modal').classList.add('active');
            document.getElementById('modal-title').innerHTML = title;
            document.getElementById('modal-body').innerHTML = content;
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        function toast(msg) {
            Toastify({ text: msg, duration: 3000, gravity: "bottom", position: "center", style: { background: "var(--primary)", borderRadius: "8px" } }).showToast();
        }

        // --- AUTH & PASSWORD RESET LOGIC ---
        let isSignup = false;
        function toggleAuth() {
            isSignup = !isSignup;
            document.getElementById('name-field').classList.toggle('hidden', !isSignup);
            
            // Toggle Forgot Password Visibility
            document.getElementById('forgot-pass-box').classList.toggle('hidden', isSignup);

            document.getElementById('auth-title').innerText = isSignup ? 'Create Account' : 'Sign In';
            document.getElementById('auth-btn').innerText = isSignup ? 'Sign Up' : 'Sign In';
            document.getElementById('auth-toggle-text').innerHTML = isSignup ? "Already have an account? <b>Sign In</b>" : "Don't have an account? <b>Sign Up</b>";
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-pass').value;
            const name = document.getElementById('user-name').value;
            const btn = document.getElementById('auth-btn');
            btn.innerText = 'Processing...';
            try {
                if(isSignup) {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await res.user.updateProfile({ displayName: name });
                    // Store user in DB with initial banned status false
                    await db.ref(`users/${res.user.uid}`).set({ 
                        name: name, 
                        email: email,
                        isBanned: false
                    });
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch(err) {
                toast(err.message);
                btn.innerText = isSignup ? 'Sign Up' : 'Sign In';
            }
        });

        // --- PASSWORD RESET FUNCTION ---
        function resetPassword() {
            const email = document.getElementById('user-email').value;

            if (!email) {
                toast("Please enter your Email Address inside the box first.");
                return;
            }

            const originalText = document.querySelector('#forgot-pass-box span').innerText;
            document.querySelector('#forgot-pass-box span').innerText = "Sending...";

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    toast("âœ… Password reset email sent! Check your inbox.");
                    document.querySelector('#forgot-pass-box span').innerText = originalText;
                })
                .catch((error) => {
                    let msg = error.message;
                    if(error.code === 'auth/user-not-found') msg = "User not found with this email.";
                    if(error.code === 'auth/invalid-email') msg = "Invalid email format.";
                    toast("âŒ " + msg);
                    document.querySelector('#forgot-pass-box span').innerText = originalText;
                });
        }

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if(!term) { renderSubjects(false); return; } // Search clear shouldn't push history
            let html = '<div class="text-center" style="margin-bottom:10px;">Search Results:</div>';
            state.subjects.forEach(sub => {
                if(sub.name.toLowerCase().includes(term)) {
                    html += `<div class="list-item" onclick="openSubject('${sub.id}')"><b>Subject: ${sub.name}</b> <i class="fas fa-arrow-right"></i></div>`;
                }
                if(sub.chapters) {
                    Object.keys(sub.chapters).forEach(cid => {
                        const ch = sub.chapters[cid];
                        if(ch.name.toLowerCase().includes(term)) {
                            html += `<div class="list-item" onclick="state.activeSubject=state.subjects.find(s=>s.id=='${sub.id}'); openChapter('${cid}')"><div><b>${ch.name}</b> <span style="font-size:0.8rem">in ${sub.name}</span></div><i class="fas fa-arrow-right"></i></div>`;
                        }
                    });
                }
            });
            els.content.innerHTML = html;
            els.breadcrumbs.classList.add('hidden');
        });

        function openFeedbackModal() { toggleSidebar(); document.getElementById('feedback-modal').classList.add('active'); }
        function submitFeedback() {
            const txt = document.getElementById('feedback-text').value;
            if(txt) {
                db.ref('feedback').push({ email: state.user.email, message: txt, status: 'unread', timestamp: firebase.database.ServerValue.TIMESTAMP }).then(() => {
                    closeModal(); document.getElementById('feedback-text').value = ''; toast('Feedback Sent!');
                });
            }
        }

        // --- REPORT QUIZ FUNCTIONS (Fixes for Z-Index) ---
        function openReportQuizModal() {
            const html = `
                <p style="margin-bottom:10px; color:var(--text-muted);">Describe the problem (e.g., Wrong Answer, Broken Layout):</p>
                <textarea id="report-text" class="input-field" rows="4" style="resize:none;" placeholder="Type issue here..."></textarea>
                <div style="text-align:right; margin-top:10px;">
                    <button class="btn btn-primary" onclick="submitQuizReport()">Submit Report</button>
                </div>
            `;
            openModal('Report Quiz Issue', html);
        }

        function submitQuizReport() {
            const issue = document.getElementById('report-text').value;
            if(!issue) { toast("Please write the issue."); return; }

            const reportData = {
                quizTitle: state.activeQuizTitle || "Unknown Quiz",
                quizUrl: state.activeQuizUrl || "Unknown URL",
                reportedBy: state.user.email,
                issue: issue,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'open'
            };

            db.ref('reports').push(reportData).then(() => {
                closeModal();
                toast("Report submitted. Admins will check it.");
            }).catch(err => toast("Error: " + err.message));
        }

        // --- PWA SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => console.log('Service Worker Registered'))
                    .catch((err) => console.log('Service Worker Error', err));
            });
        }
    </script>
</body>
</html>